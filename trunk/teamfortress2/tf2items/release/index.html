<!doctype html>

<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <link rel="stylesheet" type="text/css" href="index.css" />

    <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" />

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

    <script type="text/javascript">
        $(document).ready
        (
            function()
            {
                $("#id_profile_submit_text_profile").autocomplete
                (
                    {
                        source: ["kevinlroberts", "robinwalker", "df", "dispensergum"]
                    }
                );
            }
        );
    </script>

    <script type="text/javascript">
        function profileCheckEnter(event)
        {
            if (event.keyCode == 13)
            {
                profileSubmit();
                return false;
            }
            else
            {
                return true;
            }
        }

        function profileSubmit()
        {
            var newUrl = "index.html?profile=";

            var profileName = $("#id_profile_submit_text_profile").attr("value");
            newUrl = newUrl + profileName;

            var sortBy = $("#id_profile_submit_select_sort").attr("value");
            newUrl = newUrl + "&sort=" + sortBy;

            window.location.replace(newUrl);
        }
    </script>

    <title>tf2items</title>
</head>

<body>
    <div id="id_all">

    <h1>Team Fortress 2 Backpack Viewer</h1>

    <div id="id_profile_submit">
        <table>
            <tr>
                <td><b>Profile:</b></td>
                <td>
                    <input type="text" id="id_profile_submit_text_profile" onKeyPress="profileCheckEnter(event)" />
                </td>
                <td>
                    <input type="button" id="id_profile_submit_button_submit" value="Submit" onClick="profileSubmit()" />
                </td>
            </tr>
            <tr>
                <td><b>Sort by:</b></td>
                <td>
                    <select id="id_profile_submit_select_sort">
                        <option value="default" selected="selected">default</option>
                        <option value="key">key</option>
                        <option value="id">id</option>
                        <option value="name">name</option>
                        <option value="type">type</option>
                        <option value="quality">quality</option>
                        <option value="slot">slot</option>
                        <option value="classes">classes</option>
                        <option value="level">level</option>
                    </select>
                </td>
                <td></td>
            </tr>
        </table>
    </div>

    <p>

    <hr>
    
    <h2 id="id_profile_header">Profile</h2>

    <p>

    <div id="id_profile_summary">
        <table>
            <tr>
                <td><b>Name:</b></td>
                <td id="id_profile_summary_name"></td>

                <td></td>
                <td></td>
            </tr>
            <tr>
                <td></td>
                <td></td>

                <td></td>
                <td></td>
            </tr>
            <tr>
                <td><b>Date:</b></td>
                <td id="id_profile_summary_date"></td>

                <td><b>Steam Community URL:</b></td>
                <td id="id_profile_summary_url_steam_community"></td>
            </tr>
            <tr>
                <td><b>Time:</b></td>
                <td id="id_profile_summary_time"></td>

                <td><b>TF2 Backpack Examiner URL:</b></td>
                <td id="id_profile_summary_url_tf2items"></td>
            </tr>
        </table>
    </div>

    <p>

    <hr>

    <h2 id="id_backpack_header">Backpack</h2>

    <div id="id_items_summary">
        <table>
            <tr>
                <td><b>Items:</b></td>
                <td id="id_items_summary_n_items"></td>
            </tr>
            <tr>
                <td><b>Hats:</b></td>
                <td id="id_items_summary_n_hats"></td>
            </tr>
            <tr>
                <td><b>Metals:</b></td>
                <td id="id_items_summary_n_metals"></td>
            </tr>
            <tr>
                <td><b>Tokens:</b></td>
                <td id="id_items_summary_n_tokens"></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td><b>Total:</b></td>
                <td id="id_items_summary_n_total"></td>
            </tr>
        </table>
    </div>

    <p>

    <div id="id_items"></div>

    <p>

    <hr>

    <h2 id="id_items_found_header">Items Found</h2>

    <div id="id_items_found_summary">
        <table>
            <tr>
                <td><b>Items Found:</b></td>
                <td id="id_items_found_summary_n_items_found"></td>
            </tr>
            <tr>
                <td><b>Hats Found:</b></td>
                <td id="id_items_found_summary_n_hats_found"></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td><b>Total Found:</b></td>
                <td id="id_items_found_summary_n_total_found"></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td><b>Warning:</b></td>
                <td id="id_items_found_summary_warning"></td>
            </tr>
        </table>
    </div>

    <p>

    <div id="id_items_found"></div>

    <p>

    <hr>

    <h2 id="id_items_craft_header">Craft</h2>

    <div id="id_items_craft_summary">
        <table>
            <tr>
                <td><b>Items:</b></td>
                <td id="id_items_craft_n_items"></td>
            </tr>
            <tr>
                <td><b>Metals:</b></td>
                <td id="id_items_craft_n_metals"></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td><b>Refined Metals:</b></td>
                <td id="id_items_craft_n_refined_metals"></td>
            </tr>
            <tr>
                <td><b>Reclaimed Metals:</b></td>
                <td id="id_items_craft_n_reclaimed_metals"></td>
            </tr>
            <tr>
                <td><b>Scrap Metals:</b></td>
                <td id="id_items_craft_n_scrap_metals"></td>
            </tr>
        </table>
    </div>

    <p>

    <div id="id_items_craft"></div>

    <p>

    </div>

    <script type="text/javascript">
        $.extend
        (
            {
                getUrlVars: function()
                {
                    var vars = [], hash;
                    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                    for(var i = 0; i < hashes.length; i++)
                    {
                        hash = hashes[i].split('=');
                        vars.push(hash[0]);
                        vars[hash[0]] = hash[1];
                    }
                    return vars;
                },
                getUrlVar: function(name)
                {
                    return $.getUrlVars()[name];
                }
            }
        );

        var queryProfile = $.getUrlVar("profile");

        $("#id_profile_submit_text_profile").attr("value", queryProfile);

        $("#id_profile_summary_name").text(queryProfile);

        var querySort = $.getUrlVar("sort");

        $("#id_profile_submit_select_sort").attr("value", querySort);

        if (querySort == "default")
        {
            $("#id_items").append('<div id="id_items_page_1"></div>');
            $("#id_items").append('<div id="id_items_page_2"></div>');

            $("#id_items_page_1").append("<p>");
            $("<img />")
                .attr("src", "images/page_1_of_2.png")
                .css("vertical-align", "middle")
                .appendTo("#id_items_page_1");
            $("#id_items_page_1").append("<p>");

            $("#id_items_page_2").append("<p>");
            $("<img />")
                .attr("src", "images/page_2_of_2.png")
                .css("vertical-align", "middle")
                .appendTo("#id_items_page_2");
            $("#id_items_page_2").append("<p>");

            for (var i = 1; i < 101; i++)
            {
                var backpackPage = "#id_items_page_1";
                if (i > 50)
                    backpackPage = "#id_items_page_2";

                $("<img />")
                    .attr("id", "id_item_" + i)
                    .attr("class", "class_item")
                    .attr("src", "images/blank.png")
                    .appendTo(backpackPage);
            }
        }

        var profilePath = "profiles/" + queryProfile + ".txt";

        $.getJSON
        (
            profilePath,
            function(root)
            {
                $("#id_profile_summary_date").text(root.date);
                $("#id_profile_summary_time").text(root.time);

                $("#id_profile_summary_url_steam_community").append("<a href=\"" + root.url_steam_community + "\">" + root.url_steam_community + "</a>");
                $("#id_profile_summary_url_tf2items").append("<a href=\"" + root.url_tf2items + "\">" + root.url_tf2items + "</a>");

                $("#id_items_summary_n_items").text(root.n_items);
                $("#id_items_summary_n_hats").text(root.n_hats);
                $("#id_items_summary_n_metals").text(root.n_metals + " metal(s)" + " worth " + root.n_metals_worth + " item(s)" + " or " + Math.floor(root.n_metals_worth / 81) + " random hat(s)" + " or " + Math.floor(root.n_metals_worth / 108) + " class-specific hat(s)");
                $("#id_items_summary_n_tokens").text(root.n_tokens);
                $("#id_items_summary_n_total").text((root.n_items + root.n_hats + root.n_metals + root.n_tokens) + " / 100");

                $("#id_items_found_summary_n_items_found").text(root.n_items_found);
                $("#id_items_found_summary_n_hats_found").text(root.n_hats_found);
                $("#id_items_found_summary_n_total_found").text((root.n_items_found + root.n_hats_found));
                $("#id_items_found_summary_warning").text((100 - (root.n_items + root.n_hats + root.n_metals + root.n_tokens + root.n_items_found + root.n_hats_found)) + ' item(s) until your backpack is full!');

                function sortByKey(a, b)
                {
                    return a.key - b.key;
                }

                function sortById(a, b)
                {
                    return b.id - a.id;
                }

                function sortByName(a, b)
                {
                    return ((a.name == b.name) ? 0 :
                           ((a.name >  b.name) ? 1 : -1));
                }

                function sortByType(a, b)
                {
                    return ((a.type == b.type) ? 0 :
                           ((a.type >  b.type) ? 1 : -1));
                }

                function sortByQuality(a, b)
                {
                    return ((a.quality == b.quality) ? 0 :
                           ((a.quality >  b.quality) ? 1 : -1));
                }

                function sortBySlot(a, b)
                {
                    return ((a.slot == b.slot) ? 0 :
                           ((a.slot >  b.slot) ? 1 : -1));
                }

                function sortByClasses(a, b)
                {
                    return ((a.classes == b.classes) ? 0 :
                           ((a.classes >  b.classes) ? 1 : -1));
                }

                function sortByLevel(a, b)
                {
                    return b.level - a.level;
                }

                function sortByPosition(a, b)
                {
                    return a.position - b.position;
                }

                if (querySort == "default")
                {
                    root.items.sort(sortByKey);
                    root.items.sort(sortByPosition);
                }
                else if (querySort == "key")
                {
                    root.items.sort(sortByKey);
                }
                else if (querySort == "id")
                {
                    root.items.sort(sortById);
                }
                else if (querySort == "name")
                {
                    root.items.sort(sortByName);
                }
                else if (querySort == "type")
                {
                    root.items.sort(sortById);
                    root.items.sort(sortByType);
                }
                else if (querySort == "quality")
                {
                    root.items.sort(sortById);
                    root.items.sort(sortByType);
                    root.items.sort(sortByQuality);
                }
                else if (querySort == "slot")
                {
                    root.items.sort(sortById);
                    root.items.sort(sortBySlot);
                }
                else if (querySort == "classes")
                {
                    root.items.sort(sortById);
                    root.items.sort(sortByClasses);
                }
                else if (querySort == "level")
                {
                    root.items.sort(sortById);
                    root.items.sort(sortByType);
                    root.items.sort(sortByLevel);
                }

                $.each
                (
                    root.items,
                    function(index, item)
                    {
                        var positionType = "#id_items_null";

                        if (item.position == 0)
                        {
                            positionType = "#id_items_found";
                        }
                        else
                        {
                            positionType = "#id_items";
                        }

                        var uniqueId = -1;

                        if (querySort == "default" && item.position > 0)
                        {
                            uniqueId = item.position;
                        }
                        else
                        {
                            uniqueId = index;

                            if (item.position == 0)
                                uniqueId = uniqueId - (uniqueId * 2);
                        }

                        var imagePath = "images/" + item.image + ".png";

                        if (querySort == "default" && item.position > 0)
                        {
                            $("#id_item_" + uniqueId)
                                .attr("src", imagePath)
                                .attr("title", item.name)
                                .attr("alt", item.name);
                        }
                        else
                        {
                            $("<img />")
                                .attr("id", "id_item_" + uniqueId)
                                .attr("class", "class_item")
                                .attr("src", imagePath)
                                .attr("title", item.name)
                                .attr("alt", item.name)
                                .appendTo(positionType);
                        }

                        var offset = $("#id_item_" + uniqueId).offset();

                        var tooltipOffsetTop = 106;
                        var tooltipOffsetLeft = 0;

                        var tooltipItemNameClass = "class_tooltip_item_name_default";
                        var tooltipItemName = item.name;
                        var tooltipItemNamePrefix = "";

                        if (item.quality_integer == 7)
                        {
                            tooltipItemNameClass = "class_tooltip_item_name_community";
                            tooltipItemNamePrefix = "Community";
                        }
                        else if (item.quality_integer == 8)
                        {
                            tooltipItemNameClass = "class_tooltip_item_name_valve";
                            tooltipItemNamePrefix = "Valve";
                        }
                        else if (item.quality_integer == 9)
                        {
                            tooltipItemNameClass = "class_tooltip_item_name_self_made";
                            tooltipItemNamePrefix = "Self-Made";
                        }

                        tooltipItemName = tooltipItemNamePrefix + ' ' + item.name;

                        $("#id_item_" + uniqueId).attr("title", "");
                        $("#id_item_" + uniqueId).attr("alt", "");

                        $("#id_item_" + uniqueId).hover
                        (
                            function(e)
                            {
                                var tooltipText = "";
                                tooltipText = tooltipText + '<div class="class_tooltip">';

                                tooltipText = tooltipText + '<p class="' + tooltipItemNameClass + '">';

                                tooltipText = tooltipText + tooltipItemName;

                                if (item.equipped != 0)
                                    tooltipText = tooltipText + '<br />' + '(equipped)' + '<br />';

                                tooltipText = tooltipText + '</p>';

                                tooltipText = tooltipText + '<p class="class_tooltip_item_level">' + 'Level ' + item.level + '</p>';

                                if (item.description)
                                    tooltipText = tooltipText + '<p class="class_tooltip_item_description">' + item.description + '</p>';

                                if (item.holiday)
                                    tooltipText = tooltipText + '<p class="class_tooltip_item_holiday">' + 'Holiday Restriction: ' + item.holiday + '</p>';

                                if (item.attributes)
                                {
                                    tooltipText = tooltipText + '<p class="class_tooltip_item_attributes">';

                                    tooltipText = tooltipText + 'Special Attributes' + '<br />';

                                    $.each
                                    (
                                        item.attributes,
                                        function(index, attribute)
                                        {
                                            if (attribute.name == "Community Contributor Item" || attribute.name == "Self Made Item")
                                            {
                                                tooltipText = tooltipText + attribute.description + '<br />';
                                            }
                                            else if (attribute.name == "Soldier Medal Index")
                                            {
                                                tooltipText = tooltipText + attribute.description + ' ' + attribute.value + '<br />';
                                            }
                                        }
                                    );

                                    tooltipText = tooltipText + '</p>';
                                }

                                tooltipText = tooltipText + '</div>';

                                $("body").append(tooltipText);
                                
                                $(".class_tooltip")
                                    .css("top", (offset.top + tooltipOffsetTop) + "px")
                                    .css("left", (offset.left + tooltipOffsetLeft) + "px")
                                    .fadeIn(1);
                            },
                            function()
                            {
                                $(".class_tooltip").remove();
                            }
                        );


                        $(".class_tooltip").mousemove
                        (
                            function(e)
                            {
                                $(".class_tooltip")
                                    .css("top", (offset.top + tooltipOffsetTop) + "px")
                                    .css("left", (offset.left + tooltipOffsetLeft) + "px")
                                    .fadeIn(1);
                            }
                        );

                        if (item.equipped != 0)
                        {
                            $('<div class="class_item_equipped">Equipped<div />')
                                .css("top", (offset.top + 72) + "px")
                                .css("left", (offset.left + 20) + "px")
                                .appendTo(positionType);
                        }

                        var itemDescription =
                            "<b>uid:</b> "             + uniqueId              + "<br />" +
                            "<b>key:</b> "             + item.key              + "<br />" +
                            "<b>id:</b> "              + item.id               + "<br />" +
                            "<b>name:</b> "            + item.name             + "<br />" +
                            "<b>description:</b> "     + item.description      + "<br />" +
                            "<b>type:</b> "            + item.type             + "<br />" +
                            "<b>quality_string:</b> "  + item.quality_string   + "<br />" +
                            "<b>slot:</b> "            + item.slot             + "<br />" +
                            "<b>image:</b> "           + item.image            + "<br />" +
                            "<b>holiday:</b> "         + item.holiday          + "<br />" +
                            "<b>classes:</b> "         + item.classes          + "<br />" +
                            "<b>level:</b> "           + item.level            + "<br />" +
                            "<b>quality_integer:</b> " + item.quality_integer  + "<br />" +
                            "<b>position:</b> "        + item.position         + "<br />" +
                            "<b>equipped:</b> 0x"      + item.equipped.toString(16);

                        $("body").append('<p class="class_item_dialog" id="id_item_dialog_' + uniqueId + '"' + ' ' + 'title="' + item.name + '"' + '>' + itemDescription + '</p>');

                        $("#id_item_dialog_" + uniqueId).dialog
                        (
                            {
                                autoOpen: false,
                                position: "center",
                                buttons:
                                {
                                    OK: function()
                                    {
                                        $(this).dialog("close");
                                    }
                                }
                            }
                        );

                        $("#id_item_" + uniqueId).click
                        (
                            function()
                            {
                                $("#id_item_dialog_" + uniqueId).dialog("open");
                                return false;
                            }
                        );

                        if (item.position == 0)
                        {
                            var itemIsHatBorderColor = "white";

                            if (item.type == "Hat")
                            {
                                if (item.name == "Hat")
                                {
                                    itemIsHatBorderColor = "red";
                                }
                                else
                                {
                                    itemIsHatBorderColor = "green";
                                }

                                $("#id_item_" + index).css("border", "2px solid " + itemIsHatBorderColor);
                            }
                        }
                    }
                );

/*
                if (querySort == "default")
                {
                    var totalFound = root.n_items_found + root.n_hats_found;

                    for (var i = 1; i < 101; i++)
                    {
                        if ($("#id_item_" + i).attr("src") == "images/blank.png" && totalFound > 0)
                        {
                            $("#id_item_" + i).attr("src", "images/unknown.png");
                            totalFound = totalFound - 1;
                        }
                    }
                }
*/

                function appendCraft(a)
                {
                    var i, j, k, m;

                    a.sort(sortById);

                    var n = a.length;

                    var nItems = 0;

                    var imagePath;

                    o:for (i = 0; i < n; i++)
                    {
                        for (j = i + 1; j < n; j++)
                        {
                            if (a[i].classes == a[j].classes && a[i].type != "Hat" && a[j].type != "Hat" && a[i] != 0 && a[j] != 0)
                            {
                                for (k = j + 1; k < n; k++)
                                {
                                    if (a[i].classes == a[k].classes  && a[i].type != "Hat" && a[k].type != "Hat" && a[i] != 0 && a[k] != 0)
                                    {
                                        if (a[i].type == "Hat" || a[i].type == "Metal" || a[i].type == "Token" || a[i].quality_string == "Special" || a[i].quality_integer == 0 || a[i].quality_integer > 3)
                                            continue o;

                                        if (a[j].type == "Hat" || a[j].type == "Metal" || a[j].type == "Token" || a[j].quality_string == "Special" || a[j].quality_integer == 0 || a[j].quality_integer > 3)
                                            continue o;

                                        if (a[k].type == "Hat" || a[k].type == "Metal" || a[k].type == "Token" || a[k].quality_string == "Special" || a[k].quality_integer == 0 || a[k].quality_integer > 3)
                                            continue o;

                                        nItems += 3;

                                        imagePath = "images/" + a[i].image + ".png";

                                        $("<img />")
                                            .attr("class", "class_item")
                                            .attr("src", imagePath)
                                            .attr("title", a[i].name)
                                            .attr("alt", a[i].name)
                                            .appendTo("#id_items_craft");

                                        $("#id_items_craft").append(" + ");

                                        imagePath = "images/" + a[j].image + ".png";

                                        $("<img />")
                                            .attr("class", "class_item")
                                            .attr("src", imagePath)
                                            .attr("title", a[j].name)
                                            .attr("alt", a[j].name)
                                            .appendTo("#id_items_craft");

                                        $("#id_items_craft").append(" + ");

                                        imagePath = "images/" + a[k].image + ".png";

                                        $("<img />")
                                            .attr("class", "class_item")
                                            .attr("src", imagePath)
                                            .attr("title", a[k].name)
                                            .attr("alt", a[k].name)
                                            .appendTo("#id_items_craft");

                                        $("#id_items_craft").append(" = ");

                                        imagePath = "images/backpack/crafting/pile_of_junk.png";

                                        $("<img />")
                                            .attr("class", "class_item")
                                            .attr("src", imagePath)
                                            .attr("title", "Scrap Metal")
                                            .attr("alt", "Scrap Metal")
                                            .appendTo("#id_items_craft");

                                        $("#id_items_craft").append("<br />");

                                        a[i] = 0;
                                        a[j] = 0;
                                        a[k] = 0;

                                        continue o;
                                    }
                                }
                            }
                        }
                    }

                    var nRefinedMetals = Math.floor(nItems / 27);

                    var rRefinedMetals = nItems % 27;

                    var nReclaimedMetals = Math.floor(rRefinedMetals / 9);

                    var rReclaimedMetals = rRefinedMetals % 9;

                    var nScrapMetals = Math.floor(rReclaimedMetals / 3);

                    var rScrapMetals = rReclaimedMetals % 3;

                    $("#id_items_craft_n_items").text(nItems);
                    $("#id_items_craft_n_metals").text(nRefinedMetals + nReclaimedMetals + nScrapMetals + " metal(s)" + " worth " + Math.floor(nRefinedMetals / 3) + " random hat(s)" + " or " + Math.floor(nRefinedMetals / 4) + " class-specific hat(s)");

                    $("#id_items_craft_n_refined_metals").text(nRefinedMetals);
                    $("#id_items_craft_n_reclaimed_metals").text(nReclaimedMetals);
                    $("#id_items_craft_n_scrap_metals").text(nScrapMetals);

                    if (nRefinedMetals > 0 || nReclaimedMetals > 0 || nScrapMetals > 0)
                        $("#id_items_craft").append(" = ");

                    $("#id_items_craft").append("<br />");

                    if (nRefinedMetals > 0)
                    {
                        for (m = 0; m < nRefinedMetals; m++)
                        {
                            imagePath = "images/backpack/crafting/pile_of_junk3.png";

                            $("<img />")
                                .attr("class", "class_item")
                                .attr("src", imagePath)
                                .attr("title", "Refined Metal")
                                .attr("alt", "Refined Metal")
                                .appendTo("#id_items_craft");
                        }
                    }

                    if (nRefinedMetals > 0 && (nReclaimedMetals > 0 || nScrapMetals > 0))
                        $("#id_items_craft").append(" + ");

                    if (nReclaimedMetals > 0)
                    {
                        for (m = 0; m < nReclaimedMetals; m++)
                        {
                            imagePath = "images/backpack/crafting/pile_of_junk2.png";

                            $("<img />")
                                .attr("class", "class_item")
                                .attr("src", imagePath)
                                .attr("title", "Reclaimed Metal")
                                .attr("alt", "Reclaimed Metal")
                                .appendTo("#id_items_craft");
                        }
                    }

                    if (nReclaimedMetals > 0 && nScrapMetals > 0)
                        $("#id_items_craft").append(" + ");

                    if (nScrapMetals > 0)
                    {
                        for (m = 0; m < nScrapMetals; m++)
                        {
                            imagePath = "images/backpack/crafting/pile_of_junk.png";

                            $("<img />")
                                .attr("class", "class_item")
                                .attr("src", imagePath)
                                .attr("title", "Scrap Metal")
                                .attr("alt", "Scrap Metal")
                                .appendTo("#id_items_craft");
                        }
                    }
                }

                appendCraft(root.items);
            }
        );
    </script>
</body>

</html>
